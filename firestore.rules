rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // User profile
    match /users/{userId} {
      allow read: if true;
      allow create, update: if request.auth != null && request.auth.uid == userId;
    }

    // Ads
    match /ads/{adId} {
      allow read: if true;

      // Create ad: Only if logged in and userId matches their own ID
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.userId;

      // Update: Allow owner to update everything, OR any authenticated user to ONLY update 'likes'
      allow update: if request.auth != null && (
                      (request.auth.uid == resource.data.userId) || 
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']))
                    );

      // Delete: Only the owner of the ad
      allow delete: if request.auth != null &&
                    request.auth.uid == resource.data.userId;
    }

    // Interests (Likes)
    match /interests/{interestId} {
      allow read: if true;

      // Create interest: Only authenticated users
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.userId;

      // Delete interest: Only the user who created it
      allow delete: if request.auth != null &&
                    request.auth.uid == resource.data.userId;
    }
  }
}
